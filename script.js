
let learnedWords = JSON.parse(localStorage.getItem('learnedWords') || '{}');
let customWords = [];
let currentQuestion = null;
let question = null;
let quizMode = localStorage.getItem('quizMode') || 'en-to-ja'; // en-to-ja / ja-to-en
let correctStreaks = JSON.parse(localStorage.getItem('correctStreaks') || '{}');
let userId = localStorage.getItem('userId');
if (!userId) {
  userId = 'user-' + Math.random().toString(36).slice(2);
  localStorage.setItem('userId', userId);
}
document.getElementById('user-id-display').textContent = userId;
function setManualUserId() {
  const input = document.getElementById('manual-userid');
  const word = input.value.trim();
  if (word) {
    localStorage.setItem('userId', word);
    alert('userId„Çí„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü: ' + word);
    location.reload(); // ÂÜçË™≠„ÅøËæº„Åø„ÅßÂèçÊò†
  }
}



const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbximFpa3J21ua8wAN4MmvYWANYcEbDjZMNm4YTuPK0ksKiFWFF3nK1M43J8bclwKo_9Uw/exec';

function useDB(mode, callback) {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open('WordDB', 1);
    request.onupgradeneeded = e => {
      e.target.result.createObjectStore('words', { keyPath: 'word' });
    };
    request.onsuccess = e => {
      const db = e.target.result;
      const tx = db.transaction('words', mode);
      const store = tx.objectStore('words');
      callback(store);
      tx.oncomplete = resolve;
      tx.onerror = reject;
    };
    request.onerror = reject;
  });
}

window.addEventListener('DOMContentLoaded', () => {
  document.getElementById('loading').style.display = 'block';

  useDB('readonly', store => {
    store.getAll().onsuccess = e => {
      const localWords = e.target.result;
      if (localWords.length > 0) {
        customWords = localWords;
      }

      fetch(SHEET_API_URL)
        .then(res => res.json())
        .then(data => {
          customWords = data.map((word, i) => ({
            ...word,
            rowIndex: i
          }));

          // ‚úÖ „Åì„Åì„Åß learnedWords „Å® correctStreaks „ÇíÂÜçÊßãÁØâ
          learnedWords = {};
          correctStreaks = {};
          data.forEach(word => {
            learnedWords[word.word] = word.learned === true || word.learned === 'TRUE';
            correctStreaks[word.word] = Number(word.streak) || 0;
          });
          localStorage.setItem('learnedWords', JSON.stringify(learnedWords));
          localStorage.setItem('correctStreaks', JSON.stringify(correctStreaks));

          useDB('readwrite', store => {
            store.clear();
            customWords.forEach(word => store.put(word));
          });
          document.getElementById('loading').style.display = 'none';
          document.getElementById('word-container').style.display = 'block';
          renderWords();
        });
    };
  });
});

//------------------------------------------
// üîç Ê§úÁ¥¢Ê©üËÉΩ
//------------------------------------------
// „Éä„Éì„Éú„Çø„É≥„Çí„Åæ„Å®„ÇÅ„Å¶„ÅÑ„Çã <nav> „ÇíÂèñÂæó
const nav = document.querySelector('nav');

// Ê§úÁ¥¢„Éú„ÉÉ„ÇØ„Çπ‰ΩúÊàê
const searchBox = document.createElement('input');
searchBox.word = 'search-box';
searchBox.placeholder = 'ÂçòË™û„ÉªÊÑèÂë≥„ÅßÊ§úÁ¥¢';
searchBox.style.marginLeft = '10px';
searchBox.style.marginTop = '8px';
searchBox.style.padding = '8px';
searchBox.style.flex = '1';            // Ê®™ÂπÖ„Çí‰º∏„Å∞„ÅôÂ†¥Âêà
searchBox.style.minWidth = '150px';    // ÊúÄÂ∞èÂπÖ
searchBox.style.boxSizing = 'border-box';

// nav „ÅÆ‰∏≠„Å´Ê®™‰∏¶„Å≥„ÅßËøΩÂä†
nav.style.display = 'flex';
nav.style.alignItems = 'center';
nav.appendChild(searchBox);


searchBox.addEventListener('input', () => {
  const query = searchBox.value.trim().toLowerCase();
  if (!query) return renderWords();

  const filtered = customWords.filter(w =>
    w.userId === userId &&
    (
      (w.word && w.word.toLowerCase().includes(query)) ||
      (w.meaning_jp && w.meaning_jp.toLowerCase().includes(query)) ||
      (w.meaning && w.meaning.toLowerCase().includes(query))
    )
  );
  renderWords(filtered);
});

function updateCardDOM(word) {
  const id = word.word;
  if (!id) return;
  const container = document.getElementById('word-container');
  const sel = `.word-card[data-word="${CSS.escape(id)}"]`;
  const card = container.querySelector(sel);
  if (!card) return;

  // Êõ¥Êñ∞ÁÆáÊâÄ„ÅÆ„ÅøÂ∑ÆÂàÜ„ÅßÂèçÊò†
  const h2 = card.querySelector('h2');
  if (h2) h2.textContent = word.word || '';

  const meaningJpEl = card.querySelector('.meaning_jp');
  if (meaningJpEl) meaningJpEl.innerHTML = (word.meaning_jp || '').replace(/\n/g, '<br>') || '<br>';

  const meaningEnEl = card.querySelector('.meaning_en');
  if (meaningEnEl) meaningEnEl.innerHTML = (word.meaning || '').replace(/\n/g, '<br>') || '&nbsp;&nbsp;&nbsp;&nbsp;';

  const exampleEl = card.querySelector('.example');
  if (exampleEl) exampleEl.innerHTML = (word.example || '').replace(/\n/g, '<br>') || '&nbsp;&nbsp;&nbsp;&nbsp;';

  const categoryEl = card.querySelector('.category');
  if (categoryEl) categoryEl.textContent = word.category || '';

  const chk = card.querySelector('.learned-checkbox');
  if (chk) chk.checked = !!learnedWords[id];
}

async function addWord(wordObj) {
  await new Promise(resolve => {
    useDB('readwrite', store => {
      store.put(wordObj);
      resolve();
    });
  });

  await fetch(`${SHEET_API_URL}?action=add`, {
    method: 'POST',
    body: new URLSearchParams({
      action: 'add',
      word: wordObj.word,
      meaning_jp: wordObj.meaning_jp,
      meaning: wordObj.meaning,
      example: wordObj.example,
      category: wordObj.category,
      userId: userId
    })
  });

  // ÁîªÈù¢„Å´Êñ∞Ë¶è„Ç´„Éº„Éâ„Å†„ÅëËøΩÂä†„Åó„Å¶„Å°„Çâ„Å§„Åç„ÇíÊäë„Åà„Çã
  const container = document.getElementById('word-container');
  const card = renderCard(wordObj, customWords.length - 1);
  container.appendChild(card);

  updateProgressBar();
}

async function editWord(index, field, value) {
  const cleanValue = value.trim();
  const word = customWords[index];
  if (word.userId !== userId) return; // ‰ªñ‰∫∫„ÅÆÂçòË™û„ÅØÁ∑®ÈõÜ‰∏çÂèØ

  word[field] = cleanValue;
  customWords[index] = word;

  await new Promise((resolve) => {
    useDB('readwrite', store => {
      store.put(word);
      resolve(); // ‚úÖ IndexedDB ‰øùÂ≠òÂÆå‰∫Ü
    });
  });


  await fetch(`${SHEET_API_URL}?action=update`, {
    method: 'POST',
    body: new URLSearchParams({
      action: 'update',
      word: word.word,
      meaning_jp: word.meaning_jp,
      meaning: word.meaning,
      example: word.example,
      category: word.category,
      userId: word.userId
    })
  });

  // ÂÖ®‰ΩìÂÜçÊèèÁîª„ÅÆ‰ª£„Çè„Çä„Å´Ë©≤ÂΩì„Ç´„Éº„Éâ„ÇíÂ∑ÆÂàÜÊõ¥Êñ∞
  try { updateCardDOM(word); } catch (e) { console.error(e); }
}

async function updateLearningStatus(word, learned, streak) {
  const word2 = customWords.find(w => w.word === word && w.userId === userId);
  if (!word2) return;
  word2.learned = learned;
  word2.streak = streak;

  // „É≠„Éº„Ç´„É´„Ç≠„É£„ÉÉ„Ç∑„É•„ÇÇÁ¢∫ÂÆü„Å´Êõ¥Êñ∞„Åó„Å¶Ê∞∏Á∂öÂåñ
  learnedWords[word] = !!word2.learned;
  correctStreaks[word] = Number(word2.streak) || 0;
  localStorage.setItem('learnedWords', JSON.stringify(learnedWords));
  localStorage.setItem('correctStreaks', JSON.stringify(correctStreaks));

  await new Promise(resolve => {
    useDB('readwrite', store => {
      store.put(word2);
      resolve();
    });
  });

  try {
    await fetch(`${SHEET_API_URL}?action=update`, {
      method: 'POST',
      body: new URLSearchParams({
        action: 'update',
        word: word2.word,
        learned: word2.learned,
        streak: word2.streak,
        userId: word2.userId
      })
    });
  } catch (e) {
    console.error('Sheets update failed', e);
  }
}

function deleteWord(index) {
  const word = customWords[index];
  if (word.userId !== userId) return; // ‰ªñ‰∫∫„ÅÆÂçòË™û„ÅØÂâäÈô§‰∏çÂèØ

  const id = word.word;
  if (!confirm('„Åì„ÅÆÂçòË™û„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
  customWords.splice(index, 1);
  useDB('readwrite', store => store.delete(id));
  fetch(`${SHEET_API_URL}?action=delete&id=${id}`, {
    method: 'POST',
    body: JSON.stringify({ id, userId }),
    mode: 'no-cors'
  });

  // DOM„Åã„ÇâË©≤ÂΩì„Ç´„Éº„Éâ„ÇíÂâäÈô§ÔºàÂÖ®ÂÜçÊèèÁîª„Åó„Å™„ÅÑÔºâ
  const container = document.getElementById('word-container');
  const sel = `.word-card[data-word="${CSS.escape(id)}"]`;
  const card = container.querySelector(sel);
  if (card) card.remove();

  updateProgressBar();
}

function toggleLearned(word, checked) {
  learnedWords[word] = checked;
  localStorage.setItem('learnedWords', JSON.stringify(learnedWords));
  if (checked !== true) {
    correctStreaks[word] = 0; // ‚Üê streak „Çí„É™„Çª„ÉÉ„Éà
    localStorage.setItem('correctStreaks', JSON.stringify(correctStreaks));
  }
  updateLearningStatus(word, checked, correctStreaks[word]); // ‚Üê „Åì„Çå„ÇíËøΩÂä†
  updateProgressBar();
}

function updateProgressBar() {
  const myWords = customWords.filter(w => w.userId === userId);
  const total = myWords.length;
  const validIds = myWords.map(w => w.word);
  const learnedCount = validIds.filter(word => learnedWords[word]).length;
  const percent = total === 0 ? 0 : Math.round((learnedCount / total) * 100);

  document.getElementById('progress-text').textContent = `${percent}%`;
  const fill = document.getElementById('progress-fill');
  fill.style.width = `${percent}%`;
  fill.style.backgroundColor = percent < 40 ? 'red' : percent < 80 ? 'orange' : 'green';
}

function renderCard(word, actualIndex) {
  const isLearned = learnedWords[word.word] || false;
  const meaning_jpHTML = word.meaning_jp ? word.meaning_jp.replace(/\n/g, '<br>') : '<br>';
  const meaningHTML = word.meaning ? word.meaning.replace(/\n/g, '<br>') : '&nbsp;&nbsp;&nbsp;&nbsp;';
  const exampleHTML = word.example ? word.example.replace(/\n/g, '<br>') : '&nbsp;&nbsp;&nbsp;&nbsp;';
  const categoryHTML = typeof word.category === 'string' ? word.category.replace(/,/g, ',&nbsp;&nbsp;') : Array.isArray(word.category) ? word.category.join(',&nbsp;&nbsp;') : '';

  const card = document.createElement('div');
  card.className = 'word-card';
  card.dataset.word = word.word;
  card.innerHTML = `
    <div class="word-header">
      <h2 contenteditable="true">${word.word || ''}</h2>
      <button class="play-btn" title="Áô∫Èü≥„ÇíÂÜçÁîü">üîä</button>
    </div>

    <p class="meaning" style="display:none;"><strong>ÊÑèÂë≥:</strong> 
      <span class="value meaning_jp" contenteditable="true">${meaning_jpHTML}</span>
    </p>
    <button class="show-meaning-btn">ÊÑèÂë≥„ÇíË¶ã„Çã</button>

    <div class="row">
      <span class="label"><strong>ÂÆöÁæ©:</strong></span>
      <span class="value scrollable meaning_en" contenteditable="true">${meaningHTML}</span>
    </div>

    <div class="row">
      <span class="label "><strong>‰æãÊñá:</strong></span>
      <span class="value scrollable example" contenteditable="true">${exampleHTML}</span>
    </div>

    <div class="row">
      <span class="label"><strong>„Ç´„ÉÜ„Ç¥„É™„Éº:</strong></span>
      <span class="value category" contenteditable="true">${categoryHTML}</span>
    </div>

    <label>
      <input type="checkbox" class="learned-checkbox" ${isLearned ? 'checked' : ''}>
      ÁøíÂæóÊ∏à„Åø
    </label>

    <button class="delete-btn">ÂâäÈô§</button>
    <button class="auto-fill-btn">Ëá™ÂãïÂÖ•Âäõ</button>
  `;

  // „Ç§„Éô„É≥„ÉàÂâ≤ÂΩìÔºàÊó¢Â≠ò„ÅÆ editWord(index, field, value) „Çí‰Ωø„ÅÜÔºâ
  const h2 = card.querySelector('h2');
  if (h2) {
    h2.addEventListener('blur', () => {
      const idx = customWords.findIndex(w => w.word === word.word);
      editWord(idx, 'word', h2.textContent || '');
    });
  }

  const playBtn = card.querySelector('.play-btn');
  if (playBtn) playBtn.addEventListener('click', () => speak(String(word.word)));

  const showBtn = card.querySelector('.show-meaning-btn');
  const meaningP = card.querySelector('.meaning');
  if (showBtn && meaningP) {
    showBtn.addEventListener('click', () => {
      meaningP.style.display = 'block';
      showBtn.style.display = 'none';
    });
  }

  // contenteditable fields
  const mapField = { 'meaning_jp': '.meaning_jp', 'meaning': '.meaning_en', 'example': '.example', 'category': '.category' };
  Object.keys(mapField).forEach(field => {
    const el = card.querySelector(mapField[field]);
    if (el) {
      el.addEventListener('blur', () => {
        const idx = customWords.findIndex(w => w.word === word.word);
        editWord(idx, field, el.innerHTML || el.textContent || '');
      });
    }
  });

  const chk = card.querySelector('.learned-checkbox');
  if (chk) {
    chk.addEventListener('change', () => toggleLearned(word.word, chk.checked));
  }

  const delBtn = card.querySelector('.delete-btn');
  if (delBtn) {
    delBtn.addEventListener('click', () => {
      const idx = customWords.findIndex(w => w.word === word.word);
      if (idx !== -1) deleteWord(idx);
    });
  }

  const autoBtn = card.querySelector('.auto-fill-btn');
  if (autoBtn) {
    autoBtn.addEventListener('click', () => {
      const idx = customWords.findIndex(w => w.word === word.word);
      if (idx !== -1) {
        // Êäº‰∏ã„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ & ÈÄ£ÊâìÈò≤Ê≠¢
        autoBtn.disabled = true;
        autoBtn.textContent = 'ÂèñÂæó‰∏≠...';
        autoBtn.style.opacity = '0.5';
        autoBtn.style.pointerEvents = 'none';
        enrichWordFromDictionary(idx);
      }
    });
  }

  return card;
}

function renderWords(words = customWords) {
  const container = document.getElementById('word-container');
  container.innerHTML = '';

  const myWords = words.filter(w => w.userId === userId); // ‚Üê Ëá™ÂàÜ„ÅÆÂçòË™û„Å†„ÅëË°®Á§∫

  const batchSize = 10;
  let index = 0;

  function renderBatch() {
    const slice = myWords.slice(index, index + batchSize);
    slice.forEach((word, i) => {
      const actualIndex = customWords.findIndex(w => w.word === word.word);
      const card = renderCard(word, actualIndex);
      container.appendChild(card);
    });

    index += batchSize;
    if (index < myWords.length) {
      setTimeout(renderBatch, 50);
    } else {
      updateProgressBar();
    }
  }

  renderBatch();
}

let currentFilter = 'all'; // 'learned' / 'unlearned' / 'all'

function applyFilter(type) {
  currentFilter = type;
  const myWords = customWords.filter(w => w.userId === userId); // ‚Üê Ëá™ÂàÜ„ÅÆÂçòË™û„Å†„Åë

  let filtered = [];
  if (type === 'learned') {
    filtered = myWords.filter(word => learnedWords[word.word]);
  } else if (type === 'unlearned') {
    filtered = myWords.filter(word => !learnedWords[word.word]);
  } else {
    filtered = myWords;
  }

  renderWords(filtered);
}

function getFilteredWords() {
  const myWords = customWords.filter(w => w.userId === userId);
  if (currentFilter === 'learned') {
    return myWords.filter(word => learnedWords[word.word]);
  } else if (currentFilter === 'unlearned') {
    return myWords.filter(word => !learnedWords[word.word]);
  } else {
    return [...myWords];
  }
}

function shuffleWords() {
  const filtered = getFilteredWords();
  const shuffled = [...filtered].sort(() => Math.random() - 0.5);
  renderWords(shuffled);
}

//------------------------------------------
// üß† „ÇØ„Ç§„Ç∫Ê©üËÉΩ
//------------------------------------------
function toggleQuizMode() {
  quizMode = quizMode === 'en-to-ja' ? 'ja-to-en' : 'en-to-ja';
  localStorage.setItem('quizMode', quizMode);
  document.getElementById('quiz-mode-label').textContent = quizMode === 'en-to-ja' ? 'Ëã±‚ÜíÊó•' : 'Êó•‚ÜíËã±';
  startQuiz();
}

function startQuiz() {
  const quizArea = document.getElementById('quiz-area');
  quizArea.innerHTML = '';

  const myWords = customWords.filter(w => w.userId === userId); // ‚Üê Ëá™ÂàÜ„ÅÆÂçòË™û„Å†„Åë
  const unlearned = myWords.filter(w => !learnedWords[w.word]);
  const learned = myWords.filter(w => learnedWords[w.word]);

  let pool = [];

  if (unlearned.length > 0) {
    const sortedByStreak = [...learned].sort((a, b) => (correctStreaks[a.word] || 0) - (correctStreaks[b.word] || 0));
    pool = [...unlearned, ...sortedByStreak.slice(0, 50)]; // Êú™ÁøíÂæó„Çí‰∏≠ÂøÉ„Å´„ÄÅÁøíÂæóÊ∏à„Åø„ÇÇcorrectStreaks„ÅåÂ∞è„Åï„ÅÑ„Åª„ÅÜ„Åã„ÇâÔºïÔºêÂÄãÊ∑∑„Åú„Çã
  } else {
    pool = [...learned];
  }

  const question = pool[Math.floor(Math.random() * pool.length)];
  currentQuestion = question;

  const distractors = shuffle(
    myWords.filter(w => w.word !== question.word)
      .map(w => quizMode === 'en-to-ja' ? w.meaning_jp : w.word)
  ).slice(0, 4);

  const correctAnswer = quizMode === 'en-to-ja' ? question.meaning_jp : question.word;
  const choices = shuffle([correctAnswer, ...distractors]);

  const questionText = quizMode === 'en-to-ja'
    ? `„Äå${question.word}„Äç„ÅÆÊÑèÂë≥„ÅØÔºü`
    : `„Äå${question.meaning_jp}„Äç„Å´ÂØæÂøú„Åô„ÇãËã±ÂçòË™û„ÅØÔºü`;

  quizArea.innerHTML = `
    <h3>${questionText}<button class="play-btn" title="Áô∫Èü≥„ÇíÂÜçÁîü">üîä</button><button onclick="toggleQuizMode()">Âàá„ÇäÊõø„Åà: <span id="quiz-mode-label">${quizMode === 'en-to-ja' ? 'Ëã±‚ÜíÊó•' : 'Êó•‚ÜíËã±'}</span></button></h3>
    ${choices.map(c => `<button onclick="checkAnswer('${c}', '${correctAnswer}', '${question.word}')">${c}</button>`).join('')}
  `;

  const playBtn = quizArea.querySelector('.play-btn');
  if (playBtn) playBtn.addEventListener('click', () => speak(String(question.word)));
}

function checkAnswer(selected, correct, word) {
  const quizArea = document.getElementById('quiz-area');
  quizArea.style.backgroundColor = selected === correct ? '#d4edda' : '#f8d7da';

  setTimeout(() => {
    quizArea.style.backgroundColor = '';

    if (selected === correct) {
      correctStreaks[word] = (correctStreaks[word] || 0) + 1;
      localStorage.setItem('correctStreaks', JSON.stringify(correctStreaks));

      if (correctStreaks[word] >= 3) {
        learnedWords[word] = true;
        localStorage.setItem('learnedWords', JSON.stringify(learnedWords));
      }
    } else {
      correctStreaks[word] = 0;
      localStorage.setItem('correctStreaks', JSON.stringify(correctStreaks));

      if (learnedWords[word]) {
        learnedWords[word] = false;
        localStorage.setItem('learnedWords', JSON.stringify(learnedWords));
      }

      alert(`‰∏çÊ≠£Ëß£‚Ä¶ Ê≠£„Åó„Åè„ÅØ„Äå${correct}„Äç`);
    }

    // DB „Å®„Ç∑„Éº„Éà„Å´Á¢∫ÂÆü„Å´Áä∂ÊÖã„ÇíÈÄÅ„ÇãÔºàÊï∞ÂÄ§Âåñ„Åó„Å¶Ê∏°„ÅôÔºâ
    try {
      updateLearningStatus(word, !!learnedWords[word], Number(correctStreaks[word] || 0));
    } catch (e) {
      console.error('updateLearningStatus failed', e);
    }

    startQuiz();
  }, 500);
}

function shuffle(arr) {
  // Fisher‚ÄìYates shuffle
  const a = Array.isArray(arr) ? arr.slice() : [];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

// --- „Åì„Åì„Åã„ÇâËøΩÂä†: Èü≥Â£∞ÂÜçÁîüÊ©üËÉΩ (Web Speech API) ---
function detectLang(text) {
  if (!text) return 'en-US';
  // Êó•Êú¨Ë™ûÊñáÂ≠ó„ÅåÂê´„Åæ„Çå„Çã„Å™„ÇâÊó•Êú¨Ë™û„ÄÅ„Åù„Çå‰ª•Â§ñ„ÅØËã±Ë™û„ÇíÂü∫Êú¨„Å´„Åô„ÇãÁ∞°ÊòìÂà§ÂÆö
  if (/[‰∏Ä-ÈæØ„ÅÅ-„Çî„Ç°-„É¥„Éº„ÄÖ„ÄÜ„Ä§]/.test(text)) return 'ja-JP';
  return 'en-US';
}

let cachedVoice = null;
function pickVoiceForLang(lang) {
  const voices = window.speechSynthesis.getVoices() || [];
  const short = (lang || 'en-US').toLowerCase().slice(0,2);

  // 1) ÂêåË®ÄË™û„Åã„Å§ÂêçÂâç„Å´ Female Á≠â„ÇíÂê´„ÇÄÈü≥Â£∞„ÇíÂÑ™ÂÖà
  let v = voices.find(vo => vo.lang && vo.lang.toLowerCase().slice(0,2) === short && /female|Â•≥ÊÄß|frau|femme|woman|girl|Â•≥/i.test(vo.name));
  if (v) return v;

  // 2) ÂêåË®ÄË™û„ÅÆÊúÄÂàù„ÅÆÈü≥Â£∞
  v = voices.find(vo => vo.lang && vo.lang.toLowerCase().slice(0,2) === short);
  if (v) return v;

  // 3) „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„ÅßÂÖàÈ†≠
  return voices[0] || null;
}

// voices „ÅåË™≠„ÅøËæº„Åæ„Çå„Åü„Çø„Ç§„Éü„É≥„Ç∞„Åß„Ç≠„É£„ÉÉ„Ç∑„É•„Çí„Çª„ÉÉ„Éà
if ('speechSynthesis' in window) {
  const setInitialVoice = () => {
    if (!cachedVoice) cachedVoice = pickVoiceForLang('en-US');
  };
  // Êó¢„Å´Ë™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Çå„Å∞Âç≥„Çª„ÉÉ„Éà
  if (window.speechSynthesis.getVoices().length) setInitialVoice();
  // Âæå„Åã„ÇâË™≠„ÅøËæº„Åæ„Çå„ÇãÂ†¥Âêà„Å´ÂØæÂøú
  window.speechSynthesis.addEventListener('voiceschanged', setInitialVoice);
}

// ‰øÆÊ≠£: speak Èñ¢Êï∞„ÅßÊØéÂõûÂÜçÈÅ∏Êäû„Åó„Å™„ÅÑ„Çà„ÅÜ cachedVoice „Çí‰Ωø„ÅÜ
function speak(text, lang) {
  if (!text || typeof window === 'undefined' || !('speechSynthesis' in window)) return;
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = lang || detectLang(text);

  // „Åô„Åß„Å´„Ç≠„É£„ÉÉ„Ç∑„É•„Åï„Çå„Åü voice „Åå„ÅÇ„Çå„Å∞‰Ωø„ÅÜ„ÄÇ„Å™„Åë„Çå„Å∞ÂÄôË£ú„ÇíÂèñÂæó„Åó„Å¶„Ç≠„É£„ÉÉ„Ç∑„É•„Åó„Å¶‰Ωø„ÅÜ
  try {
    if (!cachedVoice) {
      cachedVoice = pickVoiceForLang(utter.lang);
    }
    if (cachedVoice) utter.voice = cachedVoice;
  } catch (e) {
    console.error('voice selection error', e);
  }

  try { window.speechSynthesis.cancel(); } catch (e) {}
  window.speechSynthesis.speak(utter);
}

document.getElementById('add-word-form').addEventListener('submit', function(e) {
  e.preventDefault();

  const addButton = document.getElementById('add-button');
  addButton.disabled = true;
  addButton.textContent = 'ËøΩÂä†‰∏≠...';
  addButton.style.opacity = '0.5';
  addButton.style.cursor = 'not-allowed';


  const word = document.getElementById('new-word').value.trim();
  const meaning_jp = document.getElementById('new-meaning-ja').value.trim();
  const meaning = document.getElementById('new-meaning').value.trim();
  const example = document.getElementById('new-example').value.trim();
  const category = document.getElementById('new-category').value.trim();

  if (!word) {
    addButton.disabled = false;
    addButton.textContent = 'ËøΩÂä†';
    addButton.style.opacity = '1';
    addButton.style.cursor = 'pointer';
    return;
  }

  if (customWords.some(w => w.word === word)) {
    const shouldUpdate = confirm('„Åì„ÅÆÂçòË™û„ÅØ„Åô„Åß„Å´Â≠òÂú®„Åó„Åæ„Åô„ÄÇ\nÊõ¥Êñ∞„Åó„Åæ„Åô„ÅãÔºüÔºà„Ç≠„É£„É≥„Çª„É´„Åß‰∏≠Ê≠¢Ôºâ');
    if (!shouldUpdate) {
      addButton.disabled = false;
      addButton.textContent = 'ËøΩÂä†';
      addButton.style.opacity = '1';
      addButton.style.cursor = 'pointer';
      return;
    }


    // ‚úÖ Êõ¥Êñ∞Âá¶ÁêÜÔºöIndexedDB„Å®Google Sheets„Å´‰∏äÊõ∏„Åç
    const updatedWord = {userId, word, meaning_jp, meaning, example, category};

    useDB('readwrite', store => store.put(updatedWord));

    fetch(SHEET_API_URL + '?action=update', {
      method: 'POST',
      body: JSON.stringify(updatedWord)
    }).then(() => {
      const index = customWords.findIndex(w => w.word === word);
      if (index !== -1) customWords[index] = updatedWord;
      renderWords();
      updateProgressBar();
      this.reset();
    }).catch(err => {
      alert('Google Sheets„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      console.error(err);
    }).finally(() => {
      addButton.disabled = false;
      addButton.textContent = 'ËøΩÂä†';
      addButton.style.opacity = '1';
      addButton.style.cursor = 'pointer';
    });

    return;
  }


  const newWord = { userId, word, meaning_jp, meaning, example, category };

  // IndexedDB „Å´‰øùÂ≠ò
  useDB('readwrite', store => store.put(newWord));

  // Google Sheets „Å´ÈÄÅ‰ø°
  fetch(SHEET_API_URL, {
    method: 'POST',
    body: new URLSearchParams({
      action: 'add',
      word: newWord.word,
      meaning_jp: newWord.meaning_jp,
      meaning: newWord.meaning,
      example: newWord.example,
      category: newWord.category,
      userId: newWord.userId
    })
  }).then(() => {
    customWords.push(newWord);
    renderWords();
    updateProgressBar();
    this.reset();
  }).catch(err => {
    alert('Google Sheets„Å∏„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    console.error(err);
  }).finally(() => {
    addButton.disabled = false;
    addButton.textContent = 'ËøΩÂä†';
    addButton.style.opacity = '1';
    addButton.style.cursor = 'pointer';
  });

});

function showSection(name) {
  document.getElementById('add-section').style.display = name === 'add' ? 'block' : 'none';
  document.getElementById('quiz-section').style.display = name === 'quiz' ? 'block' : 'none';

  if (name === 'quiz') startQuiz();
}

let debounceTimer;

document.getElementById('new-word').addEventListener('input', async function () {
  clearTimeout(debounceTimer);

  // ÂÖ•Âäõ„ÅåÁ©∫„Å™„ÇâË£úÂÆåÊ¨Ñ„Çí„ÇØ„É™„Ç¢„Åó„Å¶ÁµÇ‰∫Ü
  const word = this.value.trim();
  if (!word) {
    document.getElementById('new-meaning').value = '';
    document.getElementById('new-example').value = '';
    document.getElementById('new-category').value = '';
    return;
  }

  debounceTimer = setTimeout(async () => {
    const lang = 'en'; // ÂøÖË¶Å„Å´Âøú„Åò„Å¶ 'en-us', 'en-uk', 'en-cn' „Å™„Å©„Å´Â§âÊõ¥

    try {
      console.log('fetchÈñãÂßã');
      const res = await fetch(`https://cambridge-dictionaryapi.vercel.app/api/dictionary/${lang}/${word}`);
      if (!res.ok) {
        console.warn('Cambridge API returned', res.status);
        document.getElementById('new-meaning').value = '';
        document.getElementById('new-example').value = '';
        document.getElementById('new-category').value = '';
        return;
      }
      const data = await res.json();

      console.log(data); // „Éá„Éê„ÉÉ„Ç∞Áî®
      console.log(JSON.stringify(data, null, 2));
      const allExamples = Array.isArray(data.definition)
        ? data.definition.flatMap(def =>
            Array.isArray(def.example)
              ? def.example.map(e => e.text)
              : []
          )
        : [];

      const formattedMeanings = Array.isArray(data.definition)
        ? data.definition.slice(0, 3).map((d) => `${d.text}`).join('\n')
        : data.definition || '';

      const formattedExamples = allExamples
        .filter(e => e && e.trim() !== '')
        .slice(0, 2)
        .join('\n');

      const category = Array.isArray(data.pos)
        ? data.pos.filter(Boolean).join(', ')
        : typeof data.pos === 'string' ? data.pos : '';

      document.getElementById('new-meaning').value = formattedMeanings;
      document.getElementById('new-example').value = formattedExamples;
      document.getElementById('new-category').value = category;
    } catch (err) {
      console.error('ËæûÊõ∏ÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', err);
      alert('ËæûÊõ∏ÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„ÇÑÂçòË™û„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
      document.getElementById('new-meaning').value = '';
      document.getElementById('new-example').value = '';
      document.getElementById('new-category').value = '';
    }
  }, 300); // ‚Üê ÂÖ•Âäõ„ÅåÊ≠¢„Åæ„Å£„Å¶„Åã„Çâ0.3ÁßíÂæå„Å´ÂÆüË°å
});

async function enrichWordFromDictionary(index) {
  const wordObj = customWords[index];
  const card = wordObj ? document.querySelector(`.word-card[data-word="${CSS.escape(wordObj.word || '')}"]`) : null;
  let button = card ? card.querySelector('.auto-fill-btn') : null;
  if (button) {
    button.disabled = true;
    button.textContent = 'ÂèñÂæó‰∏≠...';
    button.style.opacity = '0.5';
    button.style.pointerEvents = 'none';
  }

  try {
    if (!wordObj) return;
    const word = (wordObj.word || '').trim();
    if (!word) return;
    
    const res = await fetch(`https://cambridge-dictionaryapi.vercel.app/api/dictionary/en/${word}`);
    if (!res.ok) throw new Error('Cambridge API failed');
    const data = await res.json();

    // ÂÆöÁæ©ÔºàÊúÄÂ§ß3„Å§Ôºâ
    const formattedMeanings = Array.isArray(data.definition)
      ? data.definition.slice(0, 3).map(d => d.text).join('\n')
      : data.definition || '';

    // ‰æãÊñáÔºàÊúÄÂ§ß2„Å§Ôºâ
    const allExamples = Array.isArray(data.definition)
      ? data.definition.flatMap(def => {
          if (Array.isArray(def.example)) {
            return def.example.map(e => e.text);
          } else if (def.example && typeof def.example.text === 'string') {
            return [def.example.text];
          } else {
            return [];
          }
        })
      : [];

    const formattedExamples = allExamples
      .filter(e => e && e.trim() !== '')
      .slice(0, 2)
      .join('\n');

    // ÂìÅË©ûÔºà„Ç´„ÉÜ„Ç¥„É™„ÉºÔºâ
    const category = Array.isArray(data.pos)
      ? data.pos.join(', ')
      : data.pos || '';

    wordObj.meaning = formattedMeanings;
    wordObj.example = formattedExamples;
    wordObj.category = category;

    await new Promise((resolve, reject) => {
      useDB('readwrite', store => {
        store.put(wordObj);
        resolve(); // ‚úÖ ‰øùÂ≠òÂÆå‰∫Ü
      });
    });

    const formData = new URLSearchParams();
    formData.append('action', 'update');
    formData.append('word', wordObj.word);
    formData.append('meaning', wordObj.meaning);
    formData.append('example', wordObj.example);
    formData.append('category', wordObj.category);
    formData.append('userId', wordObj.userId || userId);;

    await fetch(`${SHEET_API_URL}?action=update`, {
      method: 'POST',
      body: formData,
    });
    updateCardDOM(wordObj);
  } catch (err) {
    console.error('ËæûÊõ∏ÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', err);
    alert('ËæûÊõ∏ÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„ÇÑÂçòË™û„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
  }finally {
    if (button) {
      button.disabled = false;
      button.textContent = 'Ëá™ÂãïÂÖ•Âäõ';
      button.style.opacity = '1';
      button.style.pointerEvents = 'auto';
    }
  }
}


/*
CORS„ÇíÂõûÈÅø„Åß„Åç„Çã„ÅÆ„ÅØdoGET()„Å®doPOST()„ÅÆ„Åø„Å†„Åã„Çâ„Åô„Åπ„Å¶„ÅÆÊìç‰Ωú„ÇídoPOST()„Å´Áµ±Âêà„Åó„Å¶„ÄÅ
function editWord(index, field, value) {
  const word = customWords[index];
  word[field] = value.trim();
  useDB('readwrite', store => store.put(word));
  fetch(`${SHEET_API_URL}?action=update`, {
    method: 'POST',
    body: JSON.stringify(word),
    mode: 'no-cors'
  });
  renderWords();
}
„ÅÆ„Çà„ÅÜ„Å´mode: 'no-cors'„ÇíÊåáÂÆö„Åô„Çã

javascript:localStorage.setItem('userId','user-0')*/